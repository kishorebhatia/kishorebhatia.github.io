<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4">
<title>CloudBees Jenkins Platform: Pipeline with Docker: Labs</title>
<link rel="stylesheet" href="./build/labs.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>CloudBees Jenkins Platform: Pipeline with Docker: Labs</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">Introduction</a></li>
<li><a href="#_the_project_part_2_exercise">The Project - Part 2: Exercise</a>
<ul class="sectlevel2">
<li><a href="#_task_convert_the_job_into_a_template">Task: Convert the job into a template</a></li>
<li><a href="#_task_create_a_multi_branch_pipeline">Task: Create a Multi-Branch Pipeline</a></li>
<li><a href="#_solution_convert_the_job_into_a_template">Solution: Convert the job into a template</a></li>
<li><a href="#_solution_create_a_multi_branch_pipeline">Solution: Create a Multi-Branch Pipeline</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This workbook is designed to supplement your CloudBees Jenkins training.
It consists of a sequence of lab exercises that will introduce
Jenkins Pipeline and Docker concepts and best practices.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_project_part_2_exercise"><a class="anchor" href="#_the_project_part_2_exercise"></a>The Project - Part 2: Exercise</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The solution to all tasks is located at the end. Please try to solve them by yourself and look at the solutions only if you get stuck or want to validate your work.</p>
</div>
<div class="paragraph">
<p>The exercise consists of practicing with other job types. Since this training is language-agnostic, you are not expected to know the language. You will not need any additional tools. All the tasks should be completed with Docker.</p>
</div>
<div class="paragraph">
<p>Before diving into the exercise, please SSH into the machine you are assigned and enter the <em>/mnt/training-books-ms/exercises</em> directory. All the code you&#8217;ll need is inside.</p>
</div>
<div class="sect2">
<h3 id="_task_convert_the_job_into_a_template"><a class="anchor" href="#_task_convert_the_job_into_a_template"></a>Task: Convert the job into a template</h3>
<div class="paragraph">
<p>The requirements for this task are as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Convert the <em>docker-flow-proxy</em> Pipeline job into a Job template called <em>docker-flow-proxy-template</em>.</p>
</li>
<li>
<p>Convert repository name and container name into job properties.</p>
</li>
<li>
<p>Create a new job called <em>docker-flow-proxy-from-template</em>. The job should be based on the <em>docker-flow-template</em>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_task_create_a_multi_branch_pipeline"><a class="anchor" href="#_task_create_a_multi_branch_pipeline"></a>Task: Create a Multi-Branch Pipeline</h3>
<div class="paragraph">
<p>The requirements for this task are as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a new job called <em>docker-flow-proxy-from-git</em>.</p>
</li>
<li>
<p>The type of the job should be <em>Multibranch Pipeline</em>.</p>
</li>
<li>
<p>The repository with Jenkins file should be <em><a href="https://github.com/cloudbees/training-books-ms" class="bare">https://github.com/cloudbees/training-books-ms</a></em>.</p>
</li>
<li>
<p>The <em>master</em> branch should be excluded.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_solution_convert_the_job_into_a_template"><a class="anchor" href="#_solution_convert_the_job_into_a_template"></a>Solution: Convert the job into a template</h3>
<div class="ulist">
<ul>
<li>
<p>Click the <em>New Item</em> link located in the left-hand menu in the home screen.</p>
</li>
<li>
<p>Type <em>docker-flow-template</em> as <em>Item Name</em>, select <em>Job Template</em>, and click the <em>OK</em> button.</p>
</li>
<li>
<p>Type <em>Docker Flow Template</em> in the <em>Display Name</em> field.</p>
</li>
<li>
<p>Click the <em>Add</em> button in the <em>Attributes</em> section, type <em>repository</em> as ID and <em>Repository</em> as name.</p>
</li>
<li>
<p>Click the <em>Add</em> button in the <em>Attributes</em> section, type <em>container</em> as ID and <em>Container</em> as name.</p>
</li>
<li>
<p>Select <em>Groovy template for Pipeline</em> as the <em>Tranformer</em> type.</p>
</li>
<li>
<p>Write the following script inside the <em>Pipeline Script</em> field.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">node("cd") {
    git branch: 'pipeline', url: "https://github.com/${repository}"

    stage 'test'
    docker.image("golang").inside('-u 0:0') {
        sh 'ln -s $PWD /go/src/docker-flow'
        sh 'cd /go/src/docker-flow &amp;&amp; go get -t &amp;&amp; go test --cover -v'
        sh 'cd /go/src/docker-flow &amp;&amp; go build -v -o docker-flow-proxy'
    }

    stage 'build'
    docker.build("localhost:5000/${container}")
    docker.image("localhost:5000/${container}").push()
    archive '${container}'
}

checkpoint 'deploy'

node('production') {
    stage 'deploy'
    try {
        sh "docker rm -f ${container}"
    } catch(e) { }
    docker.image("localhost:5000/${container}").run("--name ${container} -p 8081:80 -p 8082:8080")
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Click the <em>New Item</em> link located in the left-hand menu in the home screen.</p>
</li>
<li>
<p>Type <em>docker-flow-proxy-from-template</em> as <em>Item Name</em>, select <em>Docker Flow Template</em>, and click the <em>OK</em> button.</p>
</li>
<li>
<p>Set <em>docker-flow-proxy-from-template</em> as <em>Name, _cloudbees/training-books-ms</em> as <em>Repository</em>, and <em>docker-flow-proxy</em> as <em>Container</em>.</p>
</li>
<li>
<p>Click the <em>Save</em> button.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_solution_create_a_multi_branch_pipeline"><a class="anchor" href="#_solution_create_a_multi_branch_pipeline"></a>Solution: Create a Multi-Branch Pipeline</h3>
<div class="ulist">
<ul>
<li>
<p>Click the <em>New Item</em> link located in the left-hand menu in the home screen.</p>
</li>
<li>
<p>Type <em>docker-flow-proxy-from-git</em> as <em>Item Name</em>, select <em>Multibranch Pipeline</em>, and click the <em>OK</em> button.</p>
</li>
<li>
<p>Select <em>Git</em> from the <em>Add Source</em> drop-down.</p>
</li>
<li>
<p>Type <em><a href="https://github.com/cloudbees/training-books-ms" class="bare">https://github.com/cloudbees/training-books-ms</a></em> as <em>Project Repository</em>.</p>
</li>
<li>
<p>Click the <em>Advanced</em> button and type <em>master</em> in the <em>Exclude branches</em> field.</p>
</li>
<li>
<p>Click the <em>Save</em> button.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="slides-04.html">Go back to slides</a></p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2016-06-23 10:38:00 UTC
</div>
</div>

<div id="ribbonHeader">CloudBees Jenkins Platform: Pipeline with Docker: Labs</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>
